<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ê°œë°œì ë¼ìš´ì§€&nbsp;&#124;&nbsp;ì½”ë”©í•´ì¡°</title>
	<!-- Standard css -->
	<link rel="icon" href="/img/logo/favicon.png">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/xeicon@2.3.3/xeicon.min.css">
	<!-- pub-js link -->
	<script src="/js/pub-ui-custom.js"></script>
</head>

<body>
	<!-- header ì˜ì—­ -->
	<div id="header" th:replace="~{ /include/header }"></div>
	<div class="banner-zone">
	<!-- ì²«ë²ˆì§¸ ì˜ì—­ : ë‚˜ì¤‘ì— ë³´ì-->
	<div class="banner-content">
		<div class="content-banner-title">
		<h3>ëˆ„êµ¬ë‚˜ ğŸ™Œ ììœ ë¡­ê²Œ ì±„íŒ…ë°©ì— ì°¸ì—¬í•´ ë³´ì„¸ìš”</h3>
		<p>ì§„ë¡œ ìƒë‹´ ë¬¸ì œ ì§ˆë¬¸</p>
		<p>ë“± ë‹¤ì–‘í•œ ì£¼ì œë¡œ ëŒ€í™”ì— ì°¸ì—¬í•´ ë³´ì„¸ìš”</p>
		</div>
		<div class="content-banner-img" style="padding-top: 40px;">
		<img src="/img/message.png" alt="" style="position: relative; top: 30px; width: 150px;">
		<img src="/img/aset02.png" alt="" style="position: relative; width: 80px; right: 30px; bottom: 55px;">
		</div>
	</div>
	</div>
	<div class="container">
	<div class="main-content mt50">
		<div class="chat-title-nav">
		<div class="chat-title clearfix">
			<h4>ì±„íŒ… ê²€ìƒ‰</h4>
			<div class="search-inp">
			<input type="text" name="" id="search-room" placeholder="ì±„íŒ…ë°© ì œëª©ì„ ê²€ìƒ‰í•´ ì£¼ì„¸ìš”" onkeyup="filterChatRooms()">
			</div>
			<!-- 
			<hr class="dashed mt20 mb20">
			
				<div class="chat-tag-wrap">
			<h4>íƒœê·¸ë³„ ëª¨ì•„ë³´ê¸°</h4>
			<div class="chat-tag-title">
				<button>ììœ ì£¼ì œ</button>
				<button>ì»¤ë¦¬ì–´ê³ ë¯¼</button>
				<button>ì§ˆë¬¸í•˜ê¸°</button>
				<button>ë¬¸ì œì§ˆë¬¸</button>
			</div>
			<hr class="dashed mt20 mb20">
			<div class="chat-tag-item">
				<button>ììœ ì£¼ì œ</button>
				<button>ì»¤ë¦¬ì–´ê³ ë¯¼</button>
				<button>ì§ˆë¬¸í•˜ê¸°</button>
				<button>ë¬¸ì œì§ˆë¬¸</button>
			</div>
			<p></p>
			</div>
			<div class="filter-group">
			<button class="filter">í•„í„° ì´ˆê¸°í™”</button>
			<button class="filter">í•„í„° ê²€ìƒ‰</button>
			</div>
			-->
		</div>
		</div>
		
		<!-- ì±„íŒ…ë°© ì˜ì—­ -->
		<div class="content-chat-wrap">
		<details open>
			<summary><i class="xi-forum-o"></i>ì»¨í…ì¸  ì˜ì—­</summary>
			<div class="chat-list">
			<div class="chat-list-head">
				<button onclick="createRoomPopup()">ì±„íŒ…ë°© ê°œì„¤</button>
			</div>
			<!-- ì±„íŒ…ë°© ëª©ë¡ -->
			<div th:each="chatRoom : ${chatRooms}" class="chat-list-item" id="chatRoom-list-item" th:data-idx="${chatRoom.idx}" th:data-type="${chatRoom.type}" th:data-user-in-room="${currentUserInRoom}">
				<!-- managerEmail ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ -->
				<p th:each="manager : ${chatRoom.managerEmail}">
					<img th:src="@{'/member/img/' + ${manager.email.email}}" alt="ì´ë¯¸ì§€ ë“±ë¡ ì•ˆí–ˆì„ ê²½ìš°ì— ë°©ì¥ ì´ë¯¸ì§€ë¡œ" >
				</p>
				<ol>
					<li class="room">
				 			<b><a href=javascript:void(0);>[[${chatRoom.title}]]</a></b>
						<p>ì°¸ì—¬ì ìˆ˜</p>
						<p id="entry" th:if="${chatRoom.limit == 0}">[[${memberCounts[chatRoom.idx]}]]</p>
						<p id="entry" th:unless="${chatRoom.limit == 0}">[[${memberCounts[chatRoom.idx]}]] / [[${chatRoom.limit}]]</p>
					</li>
				</ol>
				
			</div>
			<!-- ì±„íŒ…ë°© ëª©ë¡ E -->
			
			</div>
		</details>
		</div>
	</div>
	</div>
	<!-- ì•„ì½”ë””ì–¸ ì˜ì—­ ì»¤ìŠ¤í…€ -- ë‚˜ì¤‘ì— -->
	<!-- https://apost.dev/1026/ -->
	<!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Element/details -->
	<!-- footerì˜ì—­ -->
	<div id="footer" th:replace="~{ /include/footer }"></div>
	<!-- Custom Script -->
	<script type="text/javascript">
		//ì±„íŒ…ë°© ê°œì„¤ íŒì—…ì°½
		function createRoomPopup () {
			if ('[[ ${ session.email } ]]' == '') {
				Swal.fire({
					icon: 'warning',
					text: 'ë¡œê·¸ì¸ í•´ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
					confirmButtonText: 'í™•ì¸'
				})
				.then(() => {
					location.href = '/member/login';
				});
				
				return false;
			}

			//ì´ë©”ì¼ ë¯¸ì¸ì¦ ì‹œ ì¸ì¦ ìœ ë„
			if ('[[ ${ session.emailAuth } ]]' != 'Y') {
				Swal.fire({
					icon: 'error',
					html: 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>MyPageë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
					showCancelButton: true,
					confirmButtonText: 'ë„¤, ì´ë™í•©ë‹ˆë‹¤.',
					cancelButtonText: 'ì•„ë‹ˆì˜¤.'
				})
				.then((result) => {
					if (result.isConfirmed)
						location.href = '/member/mypage/main';
				});
				
				return false;
			}
			
			const options = 'width=700, height=600, top=50, left=5'
			window.open('/chat/create','_blank',options)
		}
		
		/*
		//ìœ ì € ì •ë³´ íŒì—…ì°½
		function userInfoPopup(email) {
			const options = 'width=700, height=600, top=50, left=5';
			window.open('/chat/userinfo?email=' + email, '_blank', options);
		}
		*/
		
		//ì±„íŒ… ê²€ìƒ‰
		function filterChatRooms() {
			var input, filter, chatList, chatItems, title, i, txtValue;
			input = document.getElementById('search-room');
			filter = input.value.toUpperCase();
			chatList = document.getElementsByClassName('chat-list')[0];
			chatItems = chatList.getElementsByClassName('chat-list-item');

			for (i = 0; i < chatItems.length; i++) {
				title = chatItems[i].getElementsByTagName('b')[0];
				if (title) {
					txtValue = title.textContent || title.innerText;
					if (txtValue.toUpperCase().indexOf(filter) > -1) {
						chatItems[i].style.display = "";
					} else {
						chatItems[i].style.display = "none";
					}
				}
			}
		}
		
		/* 	
		// ìœ ì € ê²€ìƒ‰ ë²„íŠ¼ ëˆ„ë¥´ë©´ ê²€ìƒ‰ì¹¸ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
		document.getElementById('search-btn').addEventListener('click', function() {
			var searchUser = document.getElementById('search-user');
			if (searchUser.style.display === 'none') {
				searchUser.style.display = 'inline';
			} else {
				searchUser.style.display = 'none';
			}
		});
	
		// ìœ ì € ê²€ìƒ‰
	 	function filterUsers() {
			var input, filter, userList, userItems, username, i, txtValue;
			input = document.getElementById('search-user');
			filter = input.value.toUpperCase();
			userList = document.getElementById('user-list');
			userItems = userList.getElementsByClassName('chat-list-item');
	
			for (i = 0; i < userItems.length; i++) {
				username = userItems[i].getElementsByTagName('b')[0];
				if (username) {
					txtValue = username.textContent || username.innerText;
					if (txtValue.toUpperCase().indexOf(filter) > -1) {
						userItems[i].style.display = "";
					} else {
						userItems[i].style.display = "none";
					}
				}
			}
		}	
		
		// ë ˆë²¨ ë°ì´í„° ê°€ê³µ
		document.addEventListener('DOMContentLoaded', function() {
			var levelElements = document.querySelectorAll('.user p span');
			levelElements.forEach(function(element) {
				var level = element.textContent;
				element.textContent = parseInt(level, 10);
			});
		});
		*/
		
		// ì±„íŒ…ë°© ì„ íƒ
		// ì±„íŒ…ë°©ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
		document.querySelectorAll('#chatRoom-list-item').forEach(item => {
			item.addEventListener('click', event => {
				if ('[[ ${ session.email } ]]' == '') {
					Swal.fire({
						icon: 'warning',
						text: 'ë¡œê·¸ì¸ í•´ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
						confirmButtonText: 'í™•ì¸'
					})
					.then(() => {
						location.href = '/member/login';
					});
					
					return false;
				}

				//ì´ë©”ì¼ ë¯¸ì¸ì¦ ì‹œ ì¸ì¦ ìœ ë„
				if ('[[ ${ session.emailAuth } ]]' != 'Y') {
					Swal.fire({
						icon: 'error',
						html: 'ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>MyPageë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
						showCancelButton: true,
						confirmButtonText: 'ë„¤, ì´ë™í•©ë‹ˆë‹¤.',
						cancelButtonText: 'ì•„ë‹ˆì˜¤.'
					})
					.then((result) => {
						if (result.isConfirmed)
							location.href = '/member/mypage/main';
					});
					
					return false;
				}
				
				const chatIdx = item.getAttribute('data-idx');
				const chatType = item.getAttribute('data-type');
				const entryElement = item.querySelector('#entry');
				const entryText = entryElement.textContent.trim();
				const [memberCount, limit] = entryText.split('/').map(Number);
	
				//bb
				// ë¡œê·¸ì¸ ì¤‘ì¸ ìœ ì €ê°€ í•´ë‹¹ ì±„íŒ…ë°©ì˜ ë©¤ë²„ì¸ì§€ í™•ì¸
				fetch(`/chat/checkMember?chatIdx=${chatIdx}`)
					.then(response => response.json())
					.then(isMember => {
						if (!isMember && memberCount >= limit && limit != 0) {
							Swal.fire({
								icon: 'warning',
								title: 'ì¸ì›ìˆ˜ê°€ ê°€ë“ì°¼ìŠµë‹ˆë‹¤.',
								text: 'ë‹¤ë¥¸ ì±„íŒ…ë°©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.',
								confirmButtonText: 'í™•ì¸'
							});
							return;
						}
						
						if (chatType === 'PVT' && !isMember) {
							// ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì„ ë°›ëŠ” SweetAlertë¡œ ë³€ê²½
							Swal.fire({
								title: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:',
								input: 'text',
								inputAttributes: {
									autocapitalize: 'off'
								},
								showCancelButton: true,
								confirmButtonText: 'í™•ì¸',
								cancelButtonText: 'ì·¨ì†Œ',
								inputValidator: (value) => {
									if (!value) {
										return 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!';
									}
									// ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ ì±„íŒ…ë°© ì§„ì…
									checkPasswordAndEnter(chatIdx, value);
								}
							});
						} else {
							// ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
							//window.location.href = `/chat/chatview?idx=${chatIdx}`;
							window.open(`/chat/chatview?idx=${chatIdx}`);
						}
					})
					.catch(error => console.error('Error:', error));
			});
		});
		
		// ë¹„ë°€ë²ˆí˜¸ ì²´í¬
		function checkPasswordAndEnter(chatIdx, password) {
			fetch('/chat/checkPassword', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: new URLSearchParams({
					'chatIdx': chatIdx,
					'password': password
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.valid) {
					//window.location.href = `/chat/chatview?idx=${chatIdx}`;
					window.open(`/chat/chatview?idx=${chatIdx}`);
				} else {
					Swal.fire({
						icon: 'error',
						title: 'ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜',
						text: 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.',
						confirmButtonText: 'í™•ì¸',
						timer: 3000,
						timerProgressBar: true
					});
				}
			})
			.catch(error => console.error('Error:', error));
		}
	
		/*
		// ìœ ì € í”„ë¡œí•„ ì„ íƒ
		document.querySelectorAll('.user-profile').forEach(item => {
			item.addEventListener('click', event => {
				const email = item.getAttribute('data-email');
				userInfoPopup(email);
			});
		});
	
		// ìœ ì € ì„ íƒí•˜ë©´ 1:1 ì±„íŒ…
		document.querySelectorAll('.user-profile').forEach(item => {
			item.addEventListener('click', event => {
				const memberEmail = item.getAttribute('data-email');
				checkOrCreatePrivateRoom(memberEmail);
			});
		});
		
		// ìœ ì € ì„ íƒ user-profileë¥¼ ì œì™¸í•œ ìœ ì €ì •ë³´ ëª¨ë“ ê³³
		// í•´ë‹¹ìœ ì €ì™€ 1:1 ëŒ€í™”ë¥¼ í–ˆëŠ”ì§€ ì²´í¬
		// 1:1ëŒ€í™”ë¥¼ ì•ˆí–ˆë‹¤ë©´ í•´ë‹¹ ìœ ì €ì™€ 1:1ëŒ€í™”í•  ê²ƒì¸ì§€ ë¬¼ì–´ë³´ê³  1:1ëŒ€í™”ë°© ìƒì„±
		// 1:1ëŒ€í™”ë¥¼ í–ˆë‹¤ë©´ ë°”ë¡œ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
	
		// 1:1 ëŒ€í™”ë°© ìƒì„±
		function checkOrCreatePrivateRoom(memberEmail) {
			fetch('/chat/checkOrCreatePrivateRoom', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: new URLSearchParams({
					'memberEmail': memberEmail
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.exists) {
					window.location.href = `/chat/chatview?idx=${data.chatIdx}`;
				} else {
					if (confirm("1:1 ëŒ€í™”ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
						window.location.href = `/chat/chatview?idx=${data.chatIdx}`;
					}
				}
			})
			.catch(error => console.error('Error:', error));
		}
	
		// ìœ ì € ì´ë¦„ ì„ íƒ
		document.querySelectorAll('.user').forEach(item => {
			item.addEventListener('click', event => {
				const email = item.querySelector('p').textContent;
				userInfoPopup(email);
			});
		});
		
		// ìœ ì € ì±„íŒ…ë°© ìƒì„±
		document.querySelectorAll('#user-list-item').forEach(item => {
			item.addEventListener('click', event => {
				const email = item.querySelector('p').textContent;
				createRoomPopup();
			});
		});
		*/
	</script>
</body>
</html>